let clients = [{
        firstName: "Estefanio",
        lastName: "de Souza",
        id: 1290763872,
        description: "Reach the full potential of your Customer Experience blueprint with Kinetic CX as your implementation",
        rate: "70.00",
        balance: "000.00",
        deposit: "560.00",
        status: "active",
        currency: "INR",
    },
    {
        firstName: "Alexis",
        lastName: "White",
        id: 1188763567,
        description: " employee development, or journey mapping, our professionals have the tools and",
        rate: "50.00",
        balance: "700.00",
        deposit: "960.00",
        status: "inactive",
        currency: "INR"
    },
    {
        firstName: "Wyatt",
        lastName: "loof Cox",
        id: 7867875643,
        description: "We provide more than just expert customer experience professionals for your project.",
        rate: "70.00",
        balance: "700.00",
        deposit: "960.00",
        status: "inactive",
        currency: "INR"
    },
    {
        firstName: "Leo",
        lastName: "Jarvi",
        id: 7376543210,
        description: "Being able to deliver consistently high levels of services across all touchpoints at every",
        rate: "60.00",
        balance: "400.00",
        deposit: "360.00",
        status: "active",
        currency: "INR"
    },
    {
        firstName: "Anaelle",
        lastName: "Olivier",
        id: 6789056789,
        description: "Organizations are continuously seeking to deliver new value for their customers to build trust and loyalty.",
        rate: "60.00",
        balance: "-350.00",
        deposit: "160.00",
        status: "active",
        currency: "INR"
    },
    {
        firstName: "Matilda",
        lastName: "Wang",
        id: 0989098767,
        description: " Let our professionals in process excellence and training instil new work practices that can",
        rate: "70.00",
        balance: "550.00",
        deposit: "500.00",
        status: "inactive",
        currency: "INR"
    },
    {
        firstName: "Pilar",
        lastName: "de Ramirez",
        id: 3345432345,
        description: "initiative, our objective is to empower your employees to deliver your CX vision continually.",
        rate: "20.00",
        balance: "900.00",
        deposit: " 100.00",
        status: "active",
        currency: "INR"
    }, {
        firstName: "James",
        lastName: "Herrera",
        id: 1123450003,
        description: "gem materials (including amber, jet, coral, ivory, pearls, tortoise-shell, and synthetic stones",
        rate: "40.00",
        balance: "-550.00",
        deposit: "709.00",
        status: "inactive",
        currency: "INR"
    }, {
        firstName: "Storm",
        lastName: "Moller",
        id: 3345432245,
        description: "Volume 2 presents a history of gem testing, describes the use and working of a number of",
        rate: "50.00",
        balance: "450.00",
        deposit: "200.00",
        status: "inactive",
        currency: "INR"
    }, {
        firstName: "Monica",
        lastName: "Cruz",
        id: 1000454323,
        description: "The title should describe what the article shows the reader. Do not begin the title with the word",
        rate: "50.00",
        balance: "-550.00",
        deposit: "879.00",
        status: "active",
        currency: "INR"
    }, {
        firstName: "Ryder",
        lastName: "Li",
        id: 3555432345,
        description: "alphabetize articles. Try “Joining a Conversation” rather than “How to Join a Conversation",
        rate: "30.00",
        balance: "-300.00",
        deposit: " 200.00",
        status: "inactive",
        currency: "INR"
    }, {
        firstName: "Emir",
        lastName: "Hoff",
        id: 1100445323,
        description: "The slug is the link to the article. Keep it short. The slug for “Joining a Conversation",
        rate: "20.00",
        balance: "-550.00",
        deposit: "700.00",
        status: "active",
        currency: "INR"
    }, {
        firstName: "Emily",
        lastName: "King",
        id: 1123455443,
        description: "Most articles are related to other articles. Type in the beginning of the name of a related article.",
        rate: "40.00",
        balance: "-200.00",
        deposit: "800.00",
        status: "inactive",
        currency: "INR"
    }, {
        firstName: "Maximilian",
        lastName: "Lucas",
        id: 7778432345,
        description: " Keywords can improve search results by adding terms that are not included in the article's Search result summary.",
        rate: "50.00",
        balance: "500.00",
        deposit: " 400.00",
        status: "active",
        currency: "INR"
    }, {
        firstName: "Vildan",
        lastName: "Tuzun",
        id: 1123888873,
        description: " Doing so will lower the amount of points awarded to your keyword, resulting in your article's search ranking diminishing. ",
        rate: "30.00",
        balance: "-250.00",
        deposit: "780.00",
        status: "inactive",
        currency: "INR"
    }, {
        firstName: "Klaus",
        lastName: "Roy",
        id: 1100004323,
        description: "In search result summary, type in a sentence or two that explains what the article is about. Try to include keywords in those sentences.",
        rate: "40.00",
        balance: "450.00",
        deposit: "760.00",
        status: "inactive",
        currency: "INR"
    }, {
        firstName: "Florencia",
        lastName: "Souza",
        id: 1123000000,
        description: "refrain from adding related documents in new articles that will be pending review. ",
        rate: "45.00",
        balance: "750.00",
        deposit: "650.00",
        status: "active",
        currency: "INR"
    }, {
        firstName: "Lorraine",
        lastName: "Chambers",
        id: 1123066700,
        description: " there are drop down menus. If your article is relevant to Firefox ",
        rate: "55.00",
        balance: "-550.00",
        deposit: "950.00",
        status: "active",
        currency: "INR"
    }, {
        firstName: "Brandon",
        lastName: "Byrd",
        id: 1123067230,
        description: "We often acquire knowledge about the world through the detailed process of Description.",
        rate: "60.00",
        balance: "250.00",
        deposit: "350.00",
        status: "inactive",
        currency: "INR"
    }, {
        firstName: "Alvin",
        lastName: "Ferguson",
        id: 8989067230,
        description: "Representing the work of students from hundreds of institutions around the globe",
        rate: "30.00",
        balance: "-550.00",
        deposit: "550.00",
        status: "inactive",
        currency: "INR"
    }, {
        firstName: "Asuncion",
        lastName: "Moreno",
        id: 8987878730,
        description: "Depending on the expedited review option you choose, you can receive a decision in as few as 5-days.",
        rate: "10.00",
        balance: "-650.00",
        deposit: "750.00",
        status: "active",
        currency: "INR"
    }
];
const tableElement = document.getElementById("table");
const searchElement = document.getElementById("search");
const statusElement = document.getElementById("status");
const nameElement = document.getElementById("name");
const activeCustomerElement = document.getElementById("active-clients");
const selectElement = document.getElementById("select");
const displayedCustomerElement = document.getElementById("displayed-customer");
const previousPageElement = document.getElementById("prevouis-page");
const nextPageElement = document.getElementById("next-page");
const notificationElement = document.getElementById("notification");
const filterElement = document.getElementById("filter");
const sortModuleElement = document.getElementById("sort-module");
const radioInputsElements = document.querySelectorAll("input[type='radio']");
const bodyElement = document.querySelector("body");
const printDeletElement = document.getElementById("print-delet-gp");
const deletSelectedElement = document.getElementById("delet-selected-customers");
const printSelectedElement = document.getElementById("print")
const checkAllInputElement = document.getElementById("check-all");
const addCustomer = document.getElementById("add");
let currentPage = 1;
let rowsPerPage;
let customersReadyToRender;
let sortBy;

function setCustomersInLocalStorageOnce(originalCustomesList) {
    if (JSON.parse(localStorage.getItem("customers")) === null) {
        return localStorage.setItem("customers", JSON.stringify(originalCustomesList));
    }
}

setCustomersInLocalStorageOnce(clients);

let customers = JSON.parse(localStorage.getItem("customers")) ? JSON.parse(localStorage.getItem("customers")).map(customer => Object.assign(customer, { "selected": false })) : [];

render(customers);
updateTableAfterUserUseForm()

radioInputsElements.forEach(input => {
    input.addEventListener("change", () => {
        sortBy = [...document.querySelectorAll("input[type='radio']:checked")].map(input => input.value);
        render(customers);
    })
})

function sortCombined(originalCustomers, sortCombinedOrders) {
    if (sortCombinedOrders === undefined) return originalCustomers;
    let sortedByNameOption = sortCustomersByName(originalCustomers, sortCombinedOrders[0]);
    return sortCustomersByStatus(sortedByNameOption, sortCombinedOrders[1]);
}

function setCustomersInLocalStorage(originalCustomesList) {
    return localStorage.setItem("customers", JSON.stringify(originalCustomesList));
}

bodyElement.addEventListener("click", (e) => {
    sortModuleElement.classList.add("hide-element");
})

checkAllInputElement.addEventListener("change", () => {
    if (checkAllInputElement.checked) {
        customersReadyToRender = customersReadyToRender.map(customer => Object.assign(customer, { "selected": true }));
    } else {
        customersReadyToRender = customersReadyToRender.map(customer => Object.assign(customer, { "selected": false }));
    }
    render(customers);
})

function changeCheckAllInputStatus(customersList) {
    let isAllChecked = customersList.every(customer => customer.selected);
    isAllChecked = customersList.length === 0 ? false : isAllChecked;
    checkAllInputElement.checked = isAllChecked ? true : false;

}

printSelectedElement.addEventListener("click", () => {
    tableElement.innerHTML = "";
    let selectedCustomers = customers.filter((customer) => customer.selected);
    selectedCustomers.forEach(customer => {
        const row = createElement(customer);
        tableElement.append(row);
    });
    window.print();
    render(customers);
})

filterElement.addEventListener("click", (e) => {
    e.stopPropagation();
    sortModuleElement.classList.toggle("hide-element");
    sortModuleElement.scrollIntoView();
})

sortModuleElement.addEventListener("click", (e) => {
    e.stopPropagation();
})

addCustomer.addEventListener("click", () => {
    let newUrl = "index.html?add=true&&spIndex=0"
    window.location.replace(newUrl);
})

function RemoveHiglightForCustomer(customerId) {
    let customerIndex = customers.findIndex(customer => customer.id == customerId);
    let isHiglighted = customers[customerIndex]["higlighted"];
    if (isHiglighted) {
        customers[customerIndex]["higlighted"] = false;
        setCustomersInLocalStorage(customers)
        setTimeout(() => {
            render(customers)
        }, 3000);
    }
    return isHiglighted;
}

deletSelectedElement.addEventListener("click", () => {
    deleteSelectedCustomers(customers);
})

function printCustomer(originalCustomers, customerId) {
    tableElement.innerHTML = "";
    let customerToPrint = originalCustomers.find((customer) => customer.id == customerId);
    const row = createElement(customerToPrint);
    tableElement.append(row);
    window.print()
    render(originalCustomers)

}

function showNotification(notification, customerName, message, isHiglighted) {
    if (isHiglighted) {
        notification.firstElementChild.innerHTML = `You've ${message} ${customerName} successfully&nbsp; <i class="fas fa-check-double"></i>
    <i class="fas fa-times"></i>`
        notification.classList.remove("hidden");
        notification.classList.add("animation-drop");
        setTimeout(() => {
            notification.classList.add("hidden");
            notification.classList.remove("animation-drop");
        }, 3000)
    }
}

function render(customersToRender) {
    tableElement.innerHTML = "";
    rowsPerPage = parseInt(selectElement.value);
    let searchedCustomers = searchCustomersByName(customersToRender);
    let sortedCombinedCustomers = sortCombined(searchedCustomers, sortBy);
    customersReadyToRender = sortedCombinedCustomers;
    showAndHidePrintDeleteElement(customersReadyToRender);
    changeCheckAllInputStatus(customersReadyToRender);
    let customersLength = customersToRender.length;
    currentPage = updateCurrentPage(customersLength, currentPage, rowsPerPage);
    let currentCustomers = customersReadyToRender.slice((currentPage - 1) * rowsPerPage, rowsPerPage * (currentPage));
    currentCustomers.forEach(customer => {
        const row = createElement(customer);
        tableElement.append(row);
    });
    activeCustomerElement.innerHTML = `active customers:
     <strong>${countActiveCustomers(customersReadyToRender)}</strong> / 
     <small>${customersReadyToRender.length}</small>`;
    let currentCustomersStart = customersReadyToRender.length === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
    let currentCustomersEnd = rowsPerPage * (currentPage) - (rowsPerPage - currentCustomers.length);
    displayedCustomerElement.innerHTML = `${currentCustomersStart}-${currentCustomersEnd} of ${customersReadyToRender.length}`;
}

function createElement(customer) {
    let { firstName, lastName, description, rate, balance, deposit, status, id, currency, higlighted, selected, protected } = customer;
    let row = document.createElement("tr");
    row.setAttribute("id", id);
    selected ? row.setAttribute("class", "selected") : false;
    higlighted ? row.setAttribute("class", "highlight") : false;
    let customerCheked = selected ? "checked" : "";
    let customerLock = protected ? "display" : "";
    let customerUnlock = protected ? "" : "display";

    row.innerHTML = `
    <td class="relative">
        <input type="checkbox" ${customerCheked} onchange="changeCustomerSelectedProperty(event ,customersReadyToRender,${id})" class="check">
        <i class="fas fa-plus" onclick="addCustomerInSpesificIndex(customers, ${id})"></i>
        <i class="far fa-copy" onclick="duplicateCustomer(customers, ${id})"></i>
        <i class="fas fa-lock ${customerLock}" onclick="unlockCustomer(customers,${id})"></i>
        <i class="fas fa-unlock ${customerUnlock}" onclick="lockCustomer(customers,${id})"></i>
    </td>
    <td>
        <h5 class="customer-name">${firstName} ${lastName}</h5>
        <div class="customer-id"> ${id}</div>
    </td>
    <td>
        <p class="description">${description}</p>
    </td>
    <td>
        <h3 class="rate-number">${rate}</h3>
        <h4 class="inr">${currency}</h4>
    </td>
    <td>
        <h3 class="${checkBalance(balance)}">${balance}</h3>
        <h4 class="inr">${currency}</h4>
    </td>
    <td>
        <h3 class="deposite-number">${deposit}</h3>
        <h4 class="inr">${currency}</h4>
    </td>
    <td>
        <button class="${status} ">${status}</button>
    </td>
     <td>
        <div class="flex">
            <i class="fas fa-pen" onClick="updateCustomer(customers,${id})"></i>
            <i class="far fa-trash-alt" onClick="deleteCustomer(customers,${id})"></i>
            <i class="fas fa-ellipsis-v" onClick="showOptions(event)"></i>
            <i class="far fa-times-circle circle hidden">
                <div class="options">                  
                    <i class="fas fa-print" onclick="printCustomer(customers,${id})"></i>    
                </div>
            </i>
        </div>
    </td>
    `;
    return row;
}

function lockCustomer(originalCustomers, customerId) {
    let customerIndex = originalCustomers.findIndex(customer => customer.id == customerId)
    originalCustomers[customerIndex]["protected"] = true;
    render(originalCustomers);
    setCustomersInLocalStorage(customers);
}

function unlockCustomer(originalCustomers, customerId) {
    let customerIndex = originalCustomers.findIndex(customer => customer.id == customerId);
    originalCustomers[customerIndex]["protected"] = false;
    render(originalCustomers);
    setCustomersInLocalStorage(customers);
}

function addCustomerInSpesificIndex(originalCustomers, customerId) {
    let index = originalCustomers.findIndex(customer => customer.id == customerId)
    index++;
    let newUrl = `index.html?add=true&&spIndex=${index}`
    window.location.replace(newUrl);
}

function duplicateCustomer(originalCustomesList, customerId) {
    let index = originalCustomesList.findIndex(customer => customer.id == customerId);
    let newUrl = `index.html?duplicate=true&&index=${index}`
    window.location.replace(newUrl);
}

function updateCustomer(originalCustomesList, customerId) {
    let isProtected = isCustomerProtected(originalCustomesList, customerId);
    if (isProtected) {
        return;
    } else {
        let index = originalCustomesList.findIndex(customer => customer.id == customerId);
        let newUrl = `index.html?update=true&&index=${index}`
        window.location.replace(newUrl);
    }
}

function showOptions(event) {
    event.stopPropagation()
    event.target.classList.toggle("hide");
    ellipsisIconElement = event.target;
    circleIconElement = event.target.nextElementSibling;
    event.target.nextElementSibling.classList.toggle("hidden");
}

function isCustomerProtected(originalCustomesList, customerId) {
    let customerIndex = originalCustomesList.findIndex((customer) => customer.id == customerId);
    if (originalCustomesList[customerIndex].protected === true) return true;
    return false;
}

function changeCustomerSelectedProperty(event, customersList, customerId) {
    let customerIndex = customersList.findIndex((customer) => customer.id == customerId);
    customersList[customerIndex]["selected"] = event.target.checked;
    render(customers);

}

function deleteSelectedCustomers(originalCustomers) {
    if (confirm("are you sure you want to delete all selected customers")) {
        customers = originalCustomers.filter((customer) => customer.selected === false || customer.protected === true);
        setCustomersInLocalStorage(customers);
        render(customers);
    }
}

function showAndHidePrintDeleteElement(originalCustomers) {
    countSelectedCustomers(originalCustomers) > 1 ? printDeletElement.classList.remove("hidden") : printDeletElement.classList.add("hidden");
}

function countSelectedCustomers(originalCustomers) {
    return originalCustomers.filter((customer) => customer.selected === true).length;
}

function checkBalance(amount) {
    if (amount > 0) return "positive";
    if (amount < 0) return "negative";
    return;
}

searchElement.addEventListener("keyup", () => {
    currentPage = 1;
    render(customers);
})

function searchCustomersByName(customersToSearchIn) {
    let searchValue = searchElement.value.toLowerCase();
    let searchedCustomers = customersToSearchIn.filter(customer => {
        return (customer.firstName.toLowerCase()).includes(searchValue) || customer.lastName.toLowerCase().includes(searchValue) || customer.description.toLowerCase().includes(searchValue);
    })
    return searchedCustomers;
}

function sortCustomersByStatus(originalCustomers, sortOrder) {
    if (sortOrder === "active") {
        statusElement.classList.add("sort-asc");
        statusElement.classList.remove("sort-desc");
        return (originalCustomers.filter((customer) => customer.status === "active"))
            .concat(originalCustomers.filter((customer) => customer.status === "inactive"))
    }

    if (sortOrder === "inactive") {
        statusElement.classList.add("sort-desc");
        statusElement.classList.remove("sort-asc");
        return (originalCustomers.filter((customer) => customer.status === "inactive"))
            .concat(originalCustomers.filter((customer) => customer.status === "active"))
    }
    statusElement.classList.remove("sort-desc", "sort-asc");
    return originalCustomers;
}

function sortCustomersByName(originalCustomers, sortOrder) {
    if (sortOrder === "asc") {
        nameElement.classList.add("sort-asc");
        nameElement.classList.remove("sort-desc");
        return originalCustomers.sort((customer1, customer2) => (customer1.firstName > customer2.firstName) ? 1 : -1);
    }

    if (sortOrder === "desc") {
        nameElement.classList.remove("sort-asc");
        nameElement.classList.add("sort-desc");
        return originalCustomers.sort((customer1, customer2) => (customer1.firstName > customer2.firstName) ? -1 : 1);
    }
    nameElement.classList.remove("sort-desc", "sort-asc");
    return originalCustomers;
}

function deleteCustomer(originalCustomers, customerId) {
    let isProtected = isCustomerProtected(originalCustomers, customerId);

    if (isProtected) return;

    if (confirm("are you sure")) {
        customers = originalCustomers.filter(customer => customer.id != customerId);
        render(customers);
        setCustomersInLocalStorage(customers);
    }
}


function updateCurrentPage(arr, currPg, rows) {
    if ((arr + rows) > currPg * rows) return currPg;
    return updateCurrentPage(arr, currPg - 1, rows)
}

function countActiveCustomers(customersToCountIn) {
    return customersToCountIn.filter(customer => customer.status === "active").length;
}

selectElement.addEventListener("change", () => {
    currentPage = 1;
    render(customers);
})

nextPageElement.addEventListener("click", () => {
    customersReadyToRender.length > rowsPerPage * currentPage ? currentPage += 1 : currentPage = currentPage;
    render(customers)
})

previousPageElement.addEventListener("click", () => {
    currentPage > 1 ? currentPage -= 1 : currentPage = currentPage;
    render(customers)
})

function getParameters(parName) {
    let parameters = new URLSearchParams(window.location.search);
    return parameters.get(parName)
}

function updateTableAfterUserUseForm() {
    if (getParameters("add")) {
        let CustomerIndex = getParameters("spIndex");
        let customerId = customers[CustomerIndex].id;
        let isHiglighted = RemoveHiglightForCustomer(customerId);
        let customerName = customers[CustomerIndex].firstName;
        showNotification(notificationElement, customerName, "add", isHiglighted);
    } else if (getParameters("duplicate") || getParameters("update")) {
        let message = getParameters("duplicate") ? "duplicate" : "update";
        let CustomerIndex = getParameters("index");
        let customerId = customers[CustomerIndex].id;
        let isHiglighted = RemoveHiglightForCustomer(customerId);
        let customerName = customers[CustomerIndex].firstName;
        showNotification(notificationElement, customerName, message, isHiglighted);
    }
}